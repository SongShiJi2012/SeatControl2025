from openpyxl import load_workbook

# === ğŸ› ï¸ å…¨å±€é…ç½®éƒ¨åˆ†ï¼ˆå¯è‡ªç”±ä¿®æ”¹ï¼‰ ===
INPUT_EXCEL_FILE = 'pin_config.xlsx'                # è¾“å…¥ Excel æ–‡ä»¶å
EXCEL_SHEET_NAME = 'PinInitCfg_P20'                # éœ€è¦è¯»å–çš„ Sheet åç§°
OUTPUT_C_FILE = 'generated_config_P20.c'           # ç”Ÿæˆçš„ .c æ–‡ä»¶å
FILE_ENCODING = 'GBK'                               # è¾“å‡ºæ–‡ä»¶ç¼–ç æ ¼å¼

def generate_config_code_with_header_and_include(excel_file, sheet_name):
    wb = load_workbook(excel_file)
    ws = wb[sheet_name]

    headers = [cell.value for cell in ws[1]]
    configs = [dict(zip(headers, row)) for row in ws.iter_rows(min_row=2, values_only=True)]

    code_lines = []

    # æ–‡ä»¶è¯´æ˜æ³¨é‡Šå¤´
    code_lines.append('/***********************************************************************************************')
    code_lines.append(f' * @file: {OUTPUT_C_FILE}')
    code_lines.append(' *')
    code_lines.append(' * @description: This file is auto-generated from Excel configuration using a Python script.')
    code_lines.append(' *               It defines the pin initialization array for SELECT_PLATFORM_PINS.')
    code_lines.append(' *')
    code_lines.append(' * @note: DO NOT EDIT THIS FILE MANUALLY.')
    code_lines.append(' ***********************************************************************************************/\n')

    # include å¤´æ–‡ä»¶
    code_lines.append('#include "pins_driver.h"\n')

    # æ•°ç»„å¼€å§‹
    code_lines.append('const pin_settings_config_t g_pin_mux_InitConfigArr[SELECT_PLATFORM_PINS] =\n{')

    for config in configs:
        pin_val = config.get('pin', '')
        notes = config.get('notes', '')

        # æ³¨é‡ŠåŒº
        if pin_val != '':
            code_lines.append(f'\t/* pin{pin_val} */')
        if notes:
            code_lines.append(f'\t/* {notes} */')

        code_lines.append('\t{')

        line_items = []

        # å›ºå®šé¡ºåºè¾“å‡º pinEnable
        pin_enable_val = config.get("pinEnable", "")
        if pin_enable_val in [True, "TRUE", "True", 1, "1"]:
            line_items.append('\t\t.pinEnable     = TRUE,')
        else:
            line_items.append('\t\t.pinEnable     = FALSE,')

        for key in headers:
            if key in ['pin', 'pinEnable', 'notes'] or config.get(key, '') == '':
                continue
            val = config[key]
            if isinstance(val, int):
                line_items.append(f'\t\t.{key} = {val}u,')
            else:
                line_items.append(f'\t\t.{key} = {val},')

        code_lines.extend(line_items)
        code_lines.append('\t},\n')

    code_lines.append('};')

    return '\n'.join(code_lines)

if __name__ == '__main__':
    code = generate_config_code_with_header_and_include(INPUT_EXCEL_FILE, EXCEL_SHEET_NAME)
    with open(OUTPUT_C_FILE, 'w', encoding=FILE_ENCODING) as f:
        f.write(code)
    print(f"âœ… é…ç½®ä»£ç å·²ç”Ÿæˆåˆ° {OUTPUT_C_FILE}ï¼Œç¼–ç æ ¼å¼: {FILE_ENCODING}")
